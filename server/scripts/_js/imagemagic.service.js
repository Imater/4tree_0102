// Generated by CoffeeScript 1.6.3
(function() {
  var fs, gm, guessLanguage, image_service, tesseract;

  gm = require('gm').subClass({
    imageMagick: true
  });

  fs = require('fs');

  tesseract = require('node-tesseract');

  guessLanguage = require('guessLanguage');

  image_service = {
    image_make_white: function(img_url) {
      var mythis, new_file_name;
      mythis = this;
      console.info(img_url);
      new_file_name = './user_data/1.png';
      return gm(img_url).write(new_file_name, function(err) {
        if (!err) {
          console.log('done');
          return mythis.recognize(new_file_name, img_url);
        } else {
          return console.log('ERROR = ', err);
        }
      });
    },
    getSize: function(img_url) {
      return gm(img_url).identify(function(err, data) {
        return console.info('size = ', data);
      });
    },
    recognize: function(img_url, old_img_url) {
      var options;
      options = {
        l: "rus+eng",
        psm: 1,
        binary: "/opt/local/bin/tesseract"
      };
      console.info('start_recognize');
      return tesseract.process(img_url, options, function(err, text) {
        if (err) {
          console.error(err);
        } else {
          guessLanguage.guessLanguage.detect(text, function(lang) {
            if (['ru', 'en', "uk", "kk", "uz", "mn", "mk", "bg", "ky"].indexOf(lang) !== -1) {
              console.log("------------------" + old_img_url + "---------------------");
              console.log("----------------PREPARE-----------------", text);
              return console.info('LANGUAGE ok = ', lang);
            } else {
              console.log("----------------PREPARE-----------------", text);
              return console.info('LANGUAGE bad = ', lang);
            }
          });
        }
      });
    }
  };

  module.exports = image_service;

}).call(this);
