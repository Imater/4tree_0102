// Generated by CoffeeScript 1.6.3
(function() {
  var $, fs, gm, guessLanguage, image_service, io, server, tesseract, tm;

  gm = require('gm').subClass({
    imageMagick: true
  });

  fs = require('fs');

  $ = require('jquery');

  server = require('http').createServer();

  io = require('socket.io').listen(server);

  tesseract = require('node-tesseract');

  guessLanguage = require('guessLanguage');

  tm = new Date().getTime();

  image_service = {
    image_make_white: function(img_url, socket_user_id) {
      var command, dfd, exec, mythis, new_file_name;
      dfd = $.Deferred();
      mythis = this;
      console.info(img_url);
      new_file_name = './user_data/1' + Math.round(Math.random() * 2000) + '.png';
      exec = require('child_process').exec;
      command = ['convert', img_url, "\\( +clone -blur 0x20 \\)", '-compose', 'Divide_Src', '-composite', new_file_name];
      exec(command.join(' '), function(err, stdout, stderr) {
        if (err) {
          console.log(err);
        }
        console.info(stdout);
        return gm(new_file_name).resize(2500, 3000).autoOrient().normalize().write(new_file_name, function(err) {
          if (!err) {
            console.log('done');
            return mythis.recognize(new_file_name, img_url, socket_user_id).then(function(text) {
              return dfd.resolve(text);
            });
          } else {
            return console.log('ERROR = ', err);
          }
        });
      });
      return dfd.promise();
    },
    getSize: function(img_url) {
      return gm(img_url).identify(function(err, data) {
        return console.info('size = ', data);
      });
    },
    recognize: function(img_url, old_img_url, socket_user_id) {
      var dfd, options;
      dfd = $.Deferred();
      options = {
        l: "rus+eng",
        psm: 1,
        binary: "/usr/local/bin/tesseract"
      };
      console.info('start_recognize');
      tesseract.process(img_url, options, function(err, text) {
        if (err) {
          console.error(err);
        } else {
          guessLanguage.guessLanguage.detect(text, function(lang) {
            if (['ru', 'en', "uk", "kk", "uz", "mn", "mk", "bg", "ky"].indexOf(lang) !== -1) {
              console.log("------------------" + img_url + "---------------------");
              console.log("----------------PREPARE-----------------", text);
              console.info('LANGUAGE ok = ', lang);
              dfd.resolve(text);
            } else {
              console.log("----------------PREPARE-----------------", text);
              console.info('LANGUAGE bad = ', lang);
              dfd.resolve(text);
            }
            console.info('time = ', new Date().getTime() - tm, socket_user_id.emit);
            return socket_user_id.emit('file_loaded', text);
          });
        }
      });
      return dfd.promise();
    }
  };

  module.exports = image_service;

}).call(this);
