// Generated by CoffeeScript 1.6.3
(function() {
  var fs, gm, guessLanguage, image_service, tesseract;

  gm = require('gm').subClass({
    imageMagick: true
  });

  fs = require('fs');

  tesseract = require('node-tesseract');

  guessLanguage = require('guessLanguage');

  image_service = {
    image_make_white: function(img_url) {
      var command, exec, mythis, new_file_name;
      mythis = this;
      console.info(img_url);
      new_file_name = './user_data/1.png';
      exec = require('child_process').exec;
      command = ['convert', img_url, "\\( +clone -blur 0x20 \\)", '-compose', 'Divide_Src', '-composite', new_file_name];
      return exec(command.join(' '), function(err, stdout, stderr) {
        if (err) {
          console.log(err);
        }
        console.info(stdout);
        return gm(new_file_name).resize(4500, 5000).autoOrient().normalize().write(new_file_name, function(err) {
          if (!err) {
            console.log('done');
            return mythis.recognize(new_file_name, img_url);
          } else {
            return console.log('ERROR = ', err);
          }
        });
      });
    },
    getSize: function(img_url) {
      return gm(img_url).identify(function(err, data) {
        return console.info('size = ', data);
      });
    },
    recognize: function(img_url, old_img_url) {
      var options;
      options = {
        l: "rus+eng",
        psm: 1,
        binary: "/usr/local/bin/tesseract"
      };
      console.info('start_recognize');
      return tesseract.process(img_url, options, function(err, text) {
        if (err) {
          console.error(err);
        } else {
          guessLanguage.guessLanguage.detect(text, function(lang) {
            if (['ru', 'en', "uk", "kk", "uz", "mn", "mk", "bg", "ky"].indexOf(lang) !== -1) {
              console.log("------------------" + img_url + "---------------------");
              console.log("----------------PREPARE-----------------", text);
              return console.info('LANGUAGE ok = ', lang);
            } else {
              console.log("----------------PREPARE-----------------", text);
              return console.info('LANGUAGE bad = ', lang);
            }
          });
        }
      });
    }
  };

  module.exports = image_service;

}).call(this);
